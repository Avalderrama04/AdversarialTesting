<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRI Imaging Classifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        .adversarial-alert {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .security-meter {
            height: 20px;
            background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .security-indicator {
            height: 100%;
            width: 0%;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            transition: width 1s;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 800px;
        }
        .upload-area {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
            margin-bottom: 2rem;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }
        #previewImage {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            display: none;
            margin: 0 auto 1.5rem auto;
        }
        .result-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
            display: none;
        }
       
        .diagnosis-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }
        .diagnostic-card {
            background-color: #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
        }
        .diagnostic-card h5 {
            color: #495057;
            margin-bottom: 1rem;
        }
        .diagnostic-card p {
            color: #6c757d;
            line-height: 1.6;
        }
        .glioma { background-color: #fff3cd; color: #856404; }
        .meningioma { background-color: #d4edda; color: #155724; }
        .notumor { background-color: #cce5ff; color: #004085; }
        .pituitary { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="display-4">Brain Tumor MRI Classifier</h1>
            <p class="lead">Upload an MRI scan to classify its tumor type!</p>
        </div>

        <div id="uploadArea" class="upload-area">
            <h4><i class="bi bi-cloud-arrow-up"></i> Upload MRI Image</h4>
            <p class="text-muted">Click to browse or drag and drop</p>
            <input type="file" id="fileInput" accept="image/*" class="d-none">
        </div>

        <div class="text-center">
            <img id="previewImage" class="img-fluid">
        </div>

        <button id="predictBtn" class="btn btn-primary btn-lg w-100 py-3" disabled onclick="predict()">
            Classify Image
        </button>
        <div id="result" class="result-card" style="display: none;">
            <h3>Diagnosis: <span id="predictionResult"></span></h3>
            <p>Confidence: <span id="confidenceValue"></span></p>

            <div id="adversarialAlert" class="alert alert-danger" style="display: none;">
                <i class="bi bi-shield-exclamation"></i> Warning: Potential adversarial image detected!
                <div class="mt-2">
                    <div class="security-meter">
                        <div id="securityIndicator" class="security-indicator"></div>
                    </div>
                </div>
            </div>
            
            <h5 class="mt-4">Probability Distribution:</h5>
            <div id="probabilityBars"></div>
        </div>
        <div id="diagnosticInfo" class="diagnostic-card">
            <h5>Diagnostic Information:</h5>
            <p id="diagnosticText"></p>
        </div>

        <div id="chat-container" style="margin-top: 30px;">
            <h3>Follow-up Chat with Gemini</h3>
            <div id="chat-log" style="border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 8px;"></div>
            <div style="margin-top: 10px;">
              <input type="text" id="chat-input" placeholder="Ask a follow-up question..." style="width: 80%; padding: 8px;" />
              <button onclick="sendChat()" style="padding: 8px 12px;">Send</button>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const predictBtn = document.getElementById('predictBtn');
        const resultDiv = document.getElementById('result');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#0d6efd';
            uploadArea.style.backgroundColor = '#f0f7ff';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#6c757d';
            uploadArea.style.backgroundColor = 'white';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#6c757d';
            uploadArea.style.backgroundColor = 'white';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                previewFile(fileInput.files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        function previewFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                predictBtn.disabled = false;
                resultDiv.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        function predict() {
            if (!fileInput.files.length) {
                showAlert('Please select an image first', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            predictBtn.disabled = true;
            predictBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Processing...
            `;
            
            resultDiv.style.display = 'none';
    
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Probabilities:", data.probabilities);

                displayResults(data);
                data.probabilities = {
                    benign: 0.75,
                    early: 0.1,
                    pre: 0.1,
                    pro: 0.05
                };
                predictBtn.disabled = false;
                predictBtn.innerHTML = 'Classify Image';
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while processing the image', 'danger');
                
                predictBtn.disabled = false;
                predictBtn.innerHTML = 'Classify Image';
            });
        }

        function showAlert(message, type) {
            const existingAlert = document.getElementById('dynamicAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'dynamicAlert';
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            uploadArea.after(alertDiv);
            
            setTimeout(() => {
                const alert = bootstrap.Alert.getInstance(alertDiv);
                if (alert) {
                    alert.close();
                }
            }, 5000);
        }

        function displayResults(data) {
            console.log("Received data from backend:", data);

            const predictionResult = document.getElementById('predictionResult');
            const advAlert = document.getElementById('adversarialAlert');
            const diagnosticDiv = document.getElementById('diagnosticInfo');
            const diagnosticText = document.getElementById('diagnosticText');
            document.getElementById("predictionResult").textContent = data.prediction;


            predictionResult.textContent = data.prediction;
            predictionResult.className = 'diagnosis-badge ' + data.prediction.toLowerCase();
            document.getElementById('confidenceValue').textContent = data.confidence;

            const probabilityBars = document.getElementById('probabilityBars');
            probabilityBars.innerHTML = '';
            
            for (const [className, prob] of Object.entries(data.probabilities)) {
                const barContainer = document.createElement('div');
                barContainer.className = 'mb-3';
                
                const labelRow = document.createElement('div');
                labelRow.className = 'd-flex justify-content-between mb-1';
                
                const label = document.createElement('span');
                label.textContent = className;
                label.className = 'text-capitalize fw-medium';
                
                const percentage = document.createElement('span');
                percentage.textContent = prob;
                
                labelRow.appendChild(label);
                labelRow.appendChild(percentage);
                barContainer.appendChild(labelRow);
                
                const progress = document.createElement('div');
                progress.className = 'probability-bar';
                
                const fill = document.createElement('div');
                fill.className = 'probability-fill';
                fill.style.width = `${Math.min(100, (prob * 100).toFixed(1))}%`; // Cap at 100%
                
                progress.appendChild(fill);
                barContainer.appendChild(progress);
                probabilityBars.appendChild(barContainer);
            }
            document.getElementById("result").style.display = "block";
                if (data.is_adversarial) {
                    advAlert.style.display = 'block';
                    advAlert.classList.add('adversarial-alert');
                } else {
                    advAlert.style.display = 'none';
                }
            
            if (data.diagnostic_info) {
                if (data.diagnostic_info.error) {
                    diagnosticText.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Note:</strong> ${data.diagnostic_info.error}
                            ${data.diagnostic_info.raw_response ? 
                            `<div class="mt-2"><small>${data.diagnostic_info.raw_response}</small></div>` : ''}
                        </div>
                    `;
                } else {
                    diagnosticText.innerHTML = formatDiagnosticInfo(data.diagnostic_info, data.anomaly_score);

                }
                diagnosticDiv.style.display = 'block';
            } else {
                diagnosticText.innerHTML = '<p>No diagnostic information available</p>';
                diagnosticDiv.style.display = 'block';
            }
        }


        function formatDiagnosticInfo(info, anomaly_score) {
            if (!info) return '<p>No diagnostic information available</p>';
        
            let html = '';
        
            if (parseFloat(anomaly_score) > 0.9) {
                html += `
                    <div class="alert alert-danger mb-3">
                        <strong>Important Note:</strong> This scan shows a high anomaly score (${anomaly_score}), 
                        indicating significant uncertainty in the classification. Expert review is strongly recommended.
                    </div>
                `;
            }
        
            if (info.key_findings) {
                html += `
                    <h5 class="mt-3">Key Findings</h5>
                    <p>${info.key_findings}</p>
                `;
            }
        
            if (info.potential_implications) {
                html += `
                    <h5 class="mt-3">Potential Implications</h5>
                    <p>${info.potential_implications}</p>
                `;
            }
        
            if (info.recommended_next_steps) {
                html += `
                    <h5 class="mt-3">Recommended Next Steps</h5>
                    <p>${info.recommended_next_steps}</p>
                `;
            }
        
            html += `
                <div class="alert alert-secondary mt-3">
                    <strong>Disclaimer:</strong> This AI analysis is for informational purposes only and 
                    does not constitute medical advice. Always consult with a qualified healthcare 
                    professional for diagnosis and treatment.
                </div>
            `;
            
            return html;
            }
        function sendChat() {
            const input = document.getElementById("chat-input");
            const message = input.value;
            if (!message.trim()) return;

            appendChatMessage("You", message);
            input.value = "";

            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.response) {
                    appendChatMessage("Gemini", data.response);
                } else {
                    appendChatMessage("Gemini", "Sorry, I couldn't process that.");
                }
            })
            .catch(err => {
                appendChatMessage("Gemini", "Error connecting to server.");
                console.error(err);
            });
        }

        async function appendChatMessage(sender, message) {
        const chatLog = document.getElementById("chat-log");
        const newMessage = document.createElement("div");
        newMessage.innerHTML = `<strong>${sender}:</strong> <p></p>`;
        chatLog.appendChild(newMessage);

        if (sender === "Gemini") {
            const parsedMessage = marked.parse(message); 
            const p = newMessage.querySelector("p");

            let i = 0;
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = parsedMessage;
            const text = tempDiv.textContent || tempDiv.innerText || ""; 

            const typingSpeed = 10; 

            function typeChar() {
                if (i < text.length) {
                    p.textContent += text[i++];
                    chatLog.scrollTo({ top: chatLog.scrollHeight, behavior: "smooth" });
                    setTimeout(typeChar, typingSpeed);
                } else {
                    p.innerHTML = parsedMessage;
                }
            }

            typeChar();
        } else {
            newMessage.innerHTML = `<strong>${sender}:</strong> <p>${message}</p>`;
        }
    }
    </script>
</body>
</html>
